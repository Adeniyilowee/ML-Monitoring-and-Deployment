services:
  ml_api:
    build:
      context: ../
      dockerfile: docker/Dockerfile
    environment:
      DB_HOST: database
      DB_PORT: 5432
      DB_USER: user
      DB_PASSWORD: ${DB_PASSWORD:-password}
      DB_NAME: ml_api
    depends_on:
      - database
    ports:
      - "5000:5000"
    command: bash -c "make db-migrations && make run-service-development"

  database:
    image: postgres:latest
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: ml_api
    ports:
      - "6609:5432"
    volumes:
      - my_dbdata:/var/lib/postgresql/data

volumes:
  my_dbdata:

# services:
#   ml_api:
#     build:
#       context: ../
#       dockerfile: docker/Dockerfile
#     environment:
#       DB_HOST: database
#       DB_PORT: 5432
#       DB_USER: user
#       DB_PASSWORD: ${DB_PASSWORD:-password}
#       DB_NAME: ml_api_dev
#     depends_on:
#       - database  # this is service defined below
#       - cadvisor  # this is service defined below
#     ports:
#       - "5002:5000"   # expose webserver to localhost host:container
#     command: bash -c "make db-migrations && make run-service-wsgi" #  this is how the makefile is called and start the connexion / swagger api

#   database:
#     image: postgres:latest
#     environment:
#       POSTGRES_USER: user
#       POSTGRES_PASSWORD: password
#       POSTGRES_DB: ml_api_dev
#     ports:
#       # expose postgres container on different host port to default (host:container)
#       - "6609:5432"
#     volumes:
#       - my_dbdata:/var/lib/postgresql/data

#   cadvisor:
#     image: google/cadvisor
#     volumes:
#       - /:/rootfs:ro
#       - /var/run:/var/run:rw
#       - /sys:/sys:ro
#       - /var/lib/docker/:/var/lib/docker:ro
#     ports:
#       - 8080:8080

#   prometheus:
#     image: prom/prometheus
#     container_name: prometheus
#     volumes:
#       - ./config/prometheus/:/etc/prometheus/
#       - prometheus_data:/prometheus
#     command:
#       - '--config.file=/etc/prometheus/prometheus.yml'
#     expose:
#       - 9090
#     ports:
#       - 9090:9090
#     depends_on:
#       - cadvisor

#   grafana:
#     image: grafana/grafana
#     depends_on:
#       - prometheus
#     ports:
#       - 3000:3000
#     volumes:
#       - grafana_data:/var/lib/grafana
#     environment:
#       - GF_SECURITY_ADMIN_PASSWORD=foobar
#       - GF_USERS_ALLOW_SIGN_UP=false

# volumes:
#   my_dbdata: {}
#   prometheus_data: {}
#   grafana_data: {}
